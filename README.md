#### ОАО «Коммерцбанк Таджикистана»
## Протокол взаимодействия партнера с интернет-эквайрингом
Данный репозиторий представляет собой описание протокола взаимодействия партнёра с интернет-эквайрингом с банковскими картами «Корти Милли» от ОАО «Коммерцбанк Таджикистана» (далее Банк).

**Версия:** 2.4

**Дата:** 2020/01/20

## Содержание
1. Общие сведения использования сервиса
    1. Правила формирования подписи
    2. Коды сервиса
2. Описание протокола
3. Входящие запросы
    1. Инициализация оплаты
    2. Проверка статуса платежа

## 1. Общие сведения использования сервиса
### 1.1. Правила формирования подписи
С данных в определенном порядке снимается `HMAC-SHA1` подпись. Ключ формирования подписи выдаётся Банком. Подпись передаётся в качестве параметра в теле запроса.

### 1.2. Коды сервиса
| Код 	| Название               	| Описание                       	| Версия протокола 	|
|-----	|------------------------	|--------------------------------	|------------------	|
| 100 	| Pending                	| В ожидании                     	| 2.2              	|
| 102 	| In process             	| В обработке                    	| 2.2              	|
| 200 	| Success                	| Успешно оплачено               	| 2.2              	|
| 400 	| Invalid merchant id    	| Неверный ID мерчанта           	| 2.2              	|
| 401 	| Invalid Security Token 	| Некорректный ключ безопасности 	| 2.2              	|
| 404 	| Not found              	| Платеж не найден               	| 2.2              	|
| 405 	| Unsupported method     	| Неподдерживаемый метод         	| 2.2              	|
| 500 	| Failed                 	| Платеж не был реализован       	| 2.2              	|
| 501 	| Canceled               	| Платеж отменён                 	| 2.2              	|
| 502 	| Rejected               	| Платеж отклонён                	| 2.2              	|

## 2. Описание протокола
1. Партнёр формирует запрос в форме `x-www-form-urlencoded` с необходимыми данными и отправляет запрос протоколом https на адрес службы банка: https://pay.cbt.tj/payment/
2. Банк проверяет все данные, сверяет токен и открывает страницу:
    1. В случае удачи, откроется страница, где клиент сможет ввести данные своей карты и оплатить.
    2. В ином случае, откроется страница с ошибкой.
3. После осуществления платежа, пользователю будет открыто модальное окно с статусом:
    1. Если платёж был реализован успешно, то пользователь, после нажатия кнопки «ОК» будет перенаправлен на адрес из параметра returnUrl.
    2. Если платеж был реализован не успешно, то пользователь, после нажатия кнопки «ОК» будет перенаправлен на адрес из параметра failUrl.
4. После перенаправления со стороны банка будет сделан запрос на адрес из параметра callbackUrl.

## 3. Входящие запросы
1. Инициализация оплаты

    ```POST /payment/```
    
    Генерируется страница для совершения платежа 
    
    **Параметры:**
    
    | Идентификатор    	| Тип     	| Описание                                                                                    	| Значение по умолчанию 	| Обязателен 	| Версия протокола 	|
    |------------------	|---------	|---------------------------------------------------------------------------------------------	|-----------------------	|------------	|------------------	|
    | aqId             	| int     	| ID мерчанта предоставленный банком                                                          	| null                  	| Да         	| 2.0              	|
    | id               	| int     	| Уникальный идентификатор платежа с вашей стороны                                            	| null                  	| Да         	| 2.0              	|
    | orderDescription 	| string  	| Описание платежа (выводится в поле описания платежа)                                        	| null                  	| Нет        	| 2.0              	|
    | amount           	| decimal 	| Сумма к снятию со счёта пользователя                                                        	| 0.0                   	| Да         	| 2.0              	|
    | currency         	| string  	| Валюта платежа. На данный момент поддерживается только TJS                                  	| TJS                   	| Нет        	| -                	|
    | login            	| string  	| Логин, предоставленный Банком                                                               	| null                  	| Да         	| 2.0              	|
    | returnUrl        	| string  	| URL, по которому можно будет вернуться, в случае удачного платежа                           	| null                  	| Да         	| 2.1              	|
    | failUrl          	| string  	| URL, по которому можно будет вернуться, в случае не удачного платежа                        	| null                  	| Да         	| 2.1              	|
    | callbackUrl      	| string  	| URL, по которому Банк отправит запрос                                                       	| null                  	| Да         	| 2.2              	|
    | token            	| string  	| Подпись, сформулированная на основании данных и пароля (см. «Правила формирования подписи») 	| null                  	| Да         	| 2.0              	|
    
    **Порядок данных для подписи:** id + orderDescription + amount + login + currency + password + privateSecurityKey
    
    **Примечания:**
    
    Длина id не должен превышать 16 символов.
    
    К началу id должно добавляться кодовое слово, которое предоставляет Банк, для создания уникальности id транзакций и их быстрой индексации/поиска.
    
    **Пример ID:** TST1234567890123
    
    **Список возможных статусов:**
    
    | Код 	| Название               	| Описание                            	| Версия протокола 	|
    |-----	|------------------------	|-------------------------------------	|------------------	|
    | 200 	| OK                     	| Успешно                             	| 1.0              	|
    | 401 	| Invalid Security Token 	| Некорректный ключ безопасности      	| 2.0              	|
    | 403 	| Forbidden              	| Нет доступа к странице              	| 2.0              	|
    | 404 	| Not found              	| Страница не найдена                 	| 1.0              	|
    | 409 	| Conflict               	| ID транзакции является некорректным 	| 2.3              	|
    | 500 	| Internal Error         	| Внутренняя ошибка сервера           	| 1.0              	|
    | 503 	| Service Unavailable    	| Сервис временно не доступен         	| 2.0              	|

2. Проверка статуса платежа

    ```GET /status/{aqId}/{paymentId}/{token}/```
    
    Запрос для проверки статуса платежа.
    
    **Параметры входящего запроса:**
    
    | Идентификатор 	| Тип    	| Описание                                                                                    	| Значение по умолчанию 	| Обязателен 	| Версия протокола 	|
    |---------------	|--------	|---------------------------------------------------------------------------------------------	|-----------------------	|------------	|------------------	|
    | aqId          	| int    	| ID мерчанта предоставленный Банком                                                          	| null                  	| Да         	| 2.2              	|
    | paymentId     	| int    	| Идентификатор платежа                                                                       	| null                  	| Да         	| 2.2              	|
    | token         	| string 	| Подпись, сформулированная на основании данных и пароля (см. «Правила формирования подписи») 	| null                  	| Да         	| 2.2              	|
    
    **Порядок данных для подписи:** paymentId + login + password + privateSecurityKey
    
    **Параметры исходящего запроса:**
    
    | Идентификатор 	| Тип    	| Описание                                                                                    	| Версия протокола 	|
    |---------------	|--------	|---------------------------------------------------------------------------------------------	|------------------	|
    | paymentId     	| int    	| Уникальный идентификатор платежа с вашей стороны                                            	| 2.2              	|
    | status_code   	| int    	| Код статуса (см. «Коды сервиса»)                                                            	| 2.2              	|
    | token         	| string 	| Подпись, сформулированная на основании данных и пароля (см. «Правила формирования подписи») 	| 2.2              	|
    
    **Порядок данных при генерации подписи:** paymentId + status_code
